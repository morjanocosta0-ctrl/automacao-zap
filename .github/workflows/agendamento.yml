const axios = require('axios');

async function executar() {
    const NINSAUDE_API_KEY = process.env.NINSAUDE_TOKEN;
    const WHAPI_TOKEN = process.env.WHAPI_TOKEN;

    // CONFIGURAÇÃO DE TESTE: Enviando apenas para o seu número
    const TELEFONE_TESTE = '5561995553393'; 

    try {
        console.log("Conectando ao Ninsaúde para extrair um exemplo...");

        const response = await axios.get('https://api.ninsaude.com/v1/agendamentos', {
            headers: { 'Authorization': `Bearer ${NINSAUDE_API_KEY}` }
        });

        const agendamentos = response.data; 

        if (!agendamentos || agendamentos.length === 0) {
            console.log("Nenhum agendamento encontrado para usar como exemplo.");
            return;
        }

        // Usaremos os dados do primeiro da lista para o seu teste
        const item = agendamentos[0];

        const mensagem = `Olá, ${item.paciente_nome}!\n\nConfirme seu agendamento na Clínica Nest - Intervenção Comportamental em ${item.atendimento_data}, às ${item.atendimento_hora}, pelo link ${item.confirmacao_link}!\n\nAgradecemos desde já!\nQualquer dúvida, estamos à disposição.`;
        
        console.log(`Enviando mensagem de teste do paciente ${item.paciente_nome} para você.`);

        try {
            await axios.post('https://gate.whapi.cloud/messages/text', {
                to: TELEFONE_TESTE,
                body: mensagem
            }, {
                headers: { 
                    'Authorization': `Bearer ${WHAPI_TOKEN}`,
                    'Content-Type': 'application/json'
                }
            });
            
            console.log(`✅ TESTE ENVIADO! Verifique seu WhatsApp (${TELEFONE_TESTE}).`);
        } catch (errorEnvio) {
            console.error(`❌ Erro no Whapi:`, errorEnvio.response ? errorEnvio.response.data : errorEnvio.message);
        }
