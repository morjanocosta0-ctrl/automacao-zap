const axios = require('axios');

async function executar() {
    const NINSAUDE_API_KEY = process.env.NINSAUDE_TOKEN;
    const WHAPI_TOKEN = process.env.WHAPI_TOKEN;
    const TELEFONE_TESTE = '5561995553393'; 

    try {
        console.log("--- DEBUG: Iniciando conexão ---");
        const response = await axios.get('https://api.ninsaude.com/v1/agendamentos', {
            headers: { 'Authorization': `Bearer ${NINSAUDE_API_KEY}` }
        });

        console.log("Dados recebidos do Ninsaúde:", JSON.stringify(response.data));

        if (!response.data || response.data.length === 0) {
            console.log("❌ ERRO: A lista do Ninsaúde veio VAZIA.");
            return;
        }

        const item = response.data[0];
        console.log(`Tentando enviar para: ${TELEFONE_TESTE} usando dados de: ${item.paciente_nome}`);

        const resWhapi = await axios.post('https://gate.whapi.cloud/messages/text', {
            to: TELEFONE_TESTE,
            body: `Teste Clínico: Olá ${item.paciente_nome}!`
        }, {
            headers: { 'Authorization': `Bearer ${WHAPI_TOKEN}` }
        });

        console.log("Resposta do Whapi:", resWhapi.data);

    } catch (error) {
        console.error("❌ FALHA NO PROCESSO:");
        if (error.response) {
            console.error("Status do Erro:", error.response.status);
            console.error("Mensagem da API:", error.response.data);
        } else {
            console.error(error.message);
        }
    }
}
executar();
